<th:block th:fragment="noticeScript">
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

    <!-- Toast Template (hidden) -->
    <template id="toast-template">
        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true" style="position: relative;">
            <div class="toast-body d-flex align-items-center" style="padding: 12px 16px;">
                <i class="fas me-2"></i>
                <span class="me-auto"></span>
                <button type="button" class="btn-close ms-2" data-bs-dismiss="toast" aria-label="Close"></button>
                <div class="progress w-100 position-absolute bottom-0 start-0" style="height: 4px;">
                    <div class="progress-bar" style="width: 100%;" role="progressbar"></div>
                </div>
            </div>
        </div>
    </template>

    <script>
        $(document).ready(function () {
            // Map server-side status to client-side status
            const statusMap = {
                'primary': 'info',
                'danger': 'error'
            };
            
            const status = /*[[${toastStatus}]]*/ 'null';
            const message = /*[[${toastMessage}]]*/ 'null';
            if (status !== 'null' && message !== 'null') {
                // Normalize status (map primary->info, danger->error, keep others as-is)
                const normalizedStatus = statusMap[status] || status;
                showToast(normalizedStatus, message);
            }

            // Auto-AJAX forms
            $('form[data-ajax="true"]').submit(function (e) {
                e.preventDefault();
                const $form = $(this);
                const url = $form.attr('action');
                const method = $form.attr('method') || 'POST';
                const formData = {};
                $form.serializeArray().forEach(({ name, value }) => formData[name] = value);

                $.ajax({
                    url: url,
                    type: method,
                    contentType: 'application/json',
                    data: JSON.stringify(formData)
                }).done(function (resp) {
                    // Normalize errorTag to match toast.js status format
                    const statusMap = { 'primary': 'info', 'danger': 'error' };
                    const normalizedStatus = statusMap[resp.errorTag] || resp.errorTag || 'error';
                    
                    // Nếu có mảng messages, show toast cho từng cái
                    if (resp.messages && Array.isArray(resp.messages)) {
                        resp.messages.forEach(msg => showToast(normalizedStatus, msg));
                    } else {
                        // fallback: single message
                        showToast(normalizedStatus, resp.message);
                    }

                    // nếu thành công và có redirectUrl
                    if (resp.status === 'ok' && resp.redirectUrl) {
                        setTimeout(() => window.location.href = resp.redirectUrl, 800);
                    }
                })
                    .fail(function () {
                        showToast('error', 'Unknown error');
                    });
            });
        });
    </script>
</th:block>